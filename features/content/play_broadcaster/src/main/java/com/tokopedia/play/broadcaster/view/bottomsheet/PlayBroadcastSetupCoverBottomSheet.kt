package com.tokopedia.play.broadcaster.view.bottomsheet

import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import androidx.fragment.app.Fragment
import androidx.fragment.app.FragmentManager
import com.tokopedia.coachmark.CoachMark2
import com.tokopedia.coachmark.CoachMark2Item
import com.tokopedia.kotlin.extensions.view.getScreenHeight
import com.tokopedia.play.broadcaster.R
import com.tokopedia.play.broadcaster.analytic.PlayBroadcastAnalytic
import com.tokopedia.play.broadcaster.databinding.BottomSheetPlayBroSetupCoverBinding
import com.tokopedia.play.broadcaster.view.fragment.setup.cover.PlayBroadcastSetupAutoGeneratedCoverFragment
import com.tokopedia.play.broadcaster.view.fragment.setup.cover.PlayBroadcastSetupCoverUploadImageFragment
import com.tokopedia.play_common.util.extension.commit
import com.tokopedia.unifycomponents.BottomSheetUnify
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.SupervisorJob
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch
import javax.inject.Inject

/**
 * Created by fachrizalmrsln on 11/01/23
 */
class PlayBroadcastSetupCoverBottomSheet @Inject constructor(
    private val analytic: PlayBroadcastAnalytic
) : BottomSheetUnify() {

    private var _binding: BottomSheetPlayBroSetupCoverBinding? = null
    private val binding: BottomSheetPlayBroSetupCoverBinding
        get() = _binding!!

    private var mListener: Listener? = null
    private var coachMark: CoachMark2? = null

    private val job = SupervisorJob()
    private val scope = CoroutineScope(Dispatchers.Main + job)

    private var isShowCoachMark = false
    private var mEntryPoint = ""

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setupBottomSheet()
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        setupView()
    }

    override fun onAttachFragment(childFragment: Fragment) {
        super.onAttachFragment(childFragment)
        when (childFragment) {
            is PlayBroadcastSetupCoverUploadImageFragment -> {
                childFragment.setupListener(mListener)
            }
            is PlayBroadcastSetupAutoGeneratedCoverFragment -> {
                coachMark?.dismissCoachMark()
                childFragment.setupListener(mListener, mEntryPoint)
            }
        }
    }

    override fun onDestroyView() {
        super.onDestroyView()
        _binding = null
        mListener = null
        coachMark = null
    }

    private fun setupBottomSheet() {
        _binding = BottomSheetPlayBroSetupCoverBinding.inflate(
            LayoutInflater.from(requireContext())
        )
        clearContentPadding = true
        setChild(binding.root)
    }

    private fun setupView() = with(binding) {
        setTitle(getString(R.string.play_bro_setup_cover_title))
        setCloseClickListener {
            analytic.clickCloseCoverBottomSheet(mEntryPoint)
            dismiss()
        }
        binding.root.layoutParams = binding.root.layoutParams.apply {
            height = (getScreenHeight() * SHEET_HEIGHT_PERCENT).toInt()
        }

        selectedContent(TAB_AUTO_GENERATED)
        csuSetupCover.isChecked = true
        csuSetupCover.setOnCheckedChangeListener { _, isChecked ->
            selectedContent(if (isChecked) TAB_AUTO_GENERATED else TAB_UPLOAD_IMAGE)
        }

        setupCoachMark()

        if (isShowCoachMark) showCoachMark()
    }

    private fun selectedContent(selectedTab: Int) = with(binding) {
        childFragmentManager.commit {
            replace(
                fragmentContainerSetupCover.id,
                if (selectedTab == TAB_AUTO_GENERATED) {
                    analytic.clickCoverTab(getString(R.string.play_bro_cover_setup_choose_template), mEntryPoint)
                    getSetupCoverChooseTemplateFragment()
                } else {
                    analytic.clickCoverTab(getString(R.string.play_bro_cover_setup_upload_image), mEntryPoint)
                    getSetupCoverUploadImageFragment()
                },
                null
            )
        }
    }

    fun show(fragmentManager: FragmentManager) {
        if (!isAdded) show(fragmentManager, TAG)
    }

    fun setupData(listener: Listener, entryPoint: String) {
        mListener = listener
        mEntryPoint = entryPoint
    }

    private fun getSetupCoverUploadImageFragment() =
        PlayBroadcastSetupCoverUploadImageFragment.getFragment(
            childFragmentManager,
            requireActivity().classLoader
        )

    private fun getSetupCoverChooseTemplateFragment() =
        PlayBroadcastSetupAutoGeneratedCoverFragment.getFragment(
            childFragmentManager,
            requireActivity().classLoader
        )

    private fun setupCoachMark() {
        coachMark = CoachMark2(requireContext())
        coachMark?.setOnDismissListener {
            analytic.clickCloseTemplateTabCoachMark()
        }
    }

    fun needToShowCoachMark(showCoachMark: Boolean) {
        isShowCoachMark = showCoachMark
    }

    private fun showCoachMark() {
        if (coachMark != null && coachMark?.isShowing == true) return
        scope.launch {
            delay(COACH_MARK_DELAY)
            coachMark?.showCoachMark(
                arrayListOf(
                    CoachMark2Item(
                        binding.viewContainerCoachMarkAutoGeneratedCover,
                        requireContext().getString(R.string.play_setup_cover_auto_generated_cover_coach_mark_title),
                        requireContext().getString(R.string.play_setup_cover_auto_generated_cover_coach_mark_description),
                        CoachMark2.POSITION_BOTTOM
                    )
                )
            )
        }
    }

    companion object {
        const val TAG = "PlayBroadcastSetupCoverBottomSheet"
        private const val SHEET_HEIGHT_PERCENT = 0.85f
        private const val COACH_MARK_DELAY = 2000L
        private const val TAB_UPLOAD_IMAGE = 1
        private const val TAB_AUTO_GENERATED = 2

        fun getFragment(
            fragmentManager: FragmentManager,
            classLoader: ClassLoader,
        ): PlayBroadcastSetupCoverBottomSheet? {
            val oldInstance =
                fragmentManager.findFragmentByTag(TAG) as? PlayBroadcastSetupCoverBottomSheet
            return oldInstance ?: fragmentManager.fragmentFactory.instantiate(
                classLoader,
                PlayBroadcastSetupCoverBottomSheet::class.java.name
            ) as? PlayBroadcastSetupCoverBottomSheet
        }
    }

    interface Listener {
        fun dismissSetupCover()
        fun setupCoverProductClicked()
    }

}
