import com.tokopedia.plugin.ScanReleaseDateTask
import com.tokopedia.plugin.ReadVersionConfigTask
import com.tokopedia.plugin.ScanProjectTask
import com.tokopedia.plugin.PublishCompositeTask

// jadi cara `ini` store semua variable diantara task
//task readGradlefile(type: ReadGradlefileTasks){
//    subprojects = project.subprojects
//    doLast{
//        latestReleaseDate = scanReleaseDate.latestReleaseDate
//        listVersion = versionDependency.listVersion
//        listTree = versionDependency.listTree
//        topList()
//        readVersionConfig()
//        moduleVersionUpdate()
//    }
//}

task scanReleaseDate(type: ScanReleaseDateTask){
    doFirst {
        println("[SCAN RELEASE DATE TASK START]")
    }
    doLast{
        println("[SCAN RELEASE DATE TASK FINISHED]")
    }
}

//task versionDependency(type: VersionTasks, dependsOn: scanReleaseDate) {
//    doFirst {
//        // simpan list release date
//        latestReleaseDate = scanReleaseDate.latestReleaseDate
//
//        // simpan root Project {Project}
//        rootProjectTask = rootProject
//    }
//    // setelah task dipanggil selesaikan dengan readGradle
////    finalizedBy readGradlefile
//}

task readVersionConfigTask(type: ReadVersionConfigTask) {
    doFirst {
        println("[READ VERSION CONFIG TASK START]")
    }
    doLast {
        println("[READ VERSION CONFIG TASK END]")
    }
}

task scanProjectTask(type: ScanProjectTask) {
    dependsOn 'scanReleaseDate'
    dependsOn 'readVersionConfigTask'
    doFirst {
        println("[VERSION TASK START]")
        versionConfigMap = readVersionConfigTask.versionConfigMap
        latestReleaseDate = scanReleaseDate.latestReleaseDate
    }
    doLast {
        println("[VERSION TASK END]")
    }
}

task versionDependency(type: PublishCompositeTask, dependsOn: scanProjectTask){
    doFirst {
        println("[PUBLISH COMPOSITE TASK START]")
        latestReleaseDate = scanProjectTask.latestReleaseDate
        dependenciesHashSet = scanProjectTask.dependenciesHashSet
        candidateModuleListToUpdate = scanProjectTask.candidateModuleListToUpdate
        versionProjectToArtifactList = scanProjectTask.versionProjectToArtifactList
        versionArtifactToProjectList = scanProjectTask.versionArtifactToProjectList
    }
    doLast{
        println("[PUBLISH COMPOSITE TASK FINISHED]")
    }
}

configurations {
    myDownloads
}
dependencies {
    myDownloads 'com.tokopedia.config:global_config:1.0.3'
}

task getDeps(type: Copy) {
    from configurations.myDownloads
    into 'tools/version/latestaar'
}